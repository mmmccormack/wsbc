<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css">
    <title>WSBC Score Tracker</title>
</head>
<body>
    <h1>WSBC Weekly Score Entry</h1>
    <h2 class="scoreAdmin">You <span class="unlock">must</span> be an administrator to track scores.</h2>

    <div class="tracker">
        <select name="scoreWeek" id="scoreWeek">
            <option value="week0" selected disabled hidden>Select Week</option>
            <option value="week1">April 30</option>
            <option value="week2">May 7</option>
            <option value="week3">May 14</option>
            <option value="week5">May 28</option>
            <option value="week6">June 4</option>
            <option value="week7">June 11</option>
            <option value="week8">June 18</option>
            <option value="week9">June 25</option>
            <option value="week11">July 9</option>
            <option value="week12">July 16</option>
            <option value="week13">July 23</option>
            <option value="week14">July 30</option>
            <option value="week16">August 13</option>
            <option value="week17">August 20</option>
            <option value="week18">August 27</option>
        </select>
    
        <div class="scoreKeeper">
    
        </div>
        <button id="submitButton" disabled="true">Submit Scores</button>

    </div>

    <a href="./index.html">Return to main page</a>
    
</body>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { push, getDatabase, ref, get, set} from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDBkWHwvti8CVooEKRZAno9NSIRRqy3JMQ",
      authDomain: "west-side-baseball-club-b9921.firebaseapp.com",
      projectId: "west-side-baseball-club-b9921",
      storageBucket: "west-side-baseball-club-b9921.appspot.com",
      messagingSenderId: "167176217443",
      appId: "1:167176217443:web:1cb69cd0f4e8bcc8bc2956"
    };

  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const dbRef = ref(database);

    // populate all scores from DB
    const weeklyScores = {};
    const weeklySchedule = ['April 30','May 7', 'May 14', 'May 21', 'May 28', 'June 4', 'June 11', 'June 18', 'June 25', 'July 2', 'July 9', 'July 16', 'July 23', 'July 30', 'August 6', 'August 13', 'August 20', 'August 27', 'September 3', 'playoffs'];
    const teamAndWinsRuns = [];
    const totalStandings = {
        'wins' : {
            'bongs' : 0,
            'balls' : 0,
            'glovers' : 0,
            'cocks' : 0
        },
        'runs' : {
            'bongs' : 0,
            'balls' : 0,
            'glovers' : 0,
            'cocks' : 0
        }

    }

    get(dbRef).then((snapshot) => {

    if(snapshot.exists()){
        const dbSnapshot = snapshot.val()['-NKd-kS06Y9qY5yLoiKZ'];
        dbSnapshot.forEach((week, index) => {
            weeklyScores[index] = week;
        })
        console.log(dbSnapshot)
    } else {
        console.log("No data available")
    }
    }).catch((error) => {
    console.log(error)
    });

    const scoreWeek = document.getElementById('scoreWeek');
    const submitButton = document.querySelector('button');
    const scoreKeeper = document.querySelector('.scoreKeeper');
    const unlock = document.querySelector('.unlock');
    const scoreAdmin = document.querySelector('.scoreAdmin');

    unlock.addEventListener('click', () => {
        document.querySelector('.tracker').classList.remove('tracker');
        scoreAdmin.style.display = 'none';
    })

    scoreWeek.addEventListener('change', e => {
        scoreKeeper.textContent = ``;
        const weekToScore = e.target.value.substring(4);
        for (let team in weeklyScores[weekToScore]) {
            const teamInput = document.createElement('input');
            teamInput.setAttribute(`id`, `${team}${weekToScore}`);
            if (weeklyScores[weekToScore][team] != '') {
                const previousScore = weeklyScores[weekToScore][team];
                teamInput.setAttribute(`placeholder`, `${team} score: ${previousScore}`);
            } else {
                teamInput.setAttribute(`placeholder`, `${team} score`);
            }
            scoreKeeper.appendChild(teamInput);
        }
        submitButton.disabled = false;
    })

    const getWinningTeam = (object, value) => {
        const winningTeam = ObjectÂ .keys(object).find(key => object[key] === value);
        const totalWins = totalStandings.wins[winningTeam];
        const totalRuns = totalStandings.runs[winningTeam];
        totalStandings.wins[winningTeam] = totalWins + 1;
        totalStandings.runs[winningTeam] = totalRuns + value;
        object[winningTeam] = '';
    }

    const getLosingTeam = (object, value) => {
        const losingTeam = Object.keys(object).find(key => object[key] === value);
        const totalRuns = totalStandings.runs[losingTeam];
        totalStandings.runs[losingTeam] = totalRuns + value;
        object[losingTeam] = '';
    }

    const findWinner = (scores, week) => {
        const homeScore = scores[0];
        const visScore = scores[1];
        if (homeScore > visScore) {
            getWinningTeam(weeklyScores[week], homeScore);
            getLosingTeam(weeklyScores[week], visScore);
            scores.shift();
            scores.shift();
        } else if (homeScore < visScore) {
            getWinningTeam(weeklyScores[week], visScore);
            getLosingTeam(weeklyScores[week], homeScore);
            scores.shift();
            scores.shift();
        } else {
            scores.shift();
            scores.shift();
        }
    }

    submitButton.addEventListener('click', e => {
        e.preventDefault();
        const weeksScores = document.querySelectorAll('input');
        let weekInQuestion = 0;
        weeksScores.forEach(team => {
            const score = Number(team.value);
            let scoreForTeam;
            // if no value is entered in when you first add scores, the empty fields will be set to zero
            if (team.placeholder.slice(-2) === 're' && score === 0) {
                alert(`You did not enter a value for ${team.id.slice(0, -1)}, so they will have a score of zero unless otherwise changed.`);
                scoreForTeam = 0;
            // if you're re-entering scores and you leave one empty, it will keep the previous value that you put into the field.
            } else if (typeof Number(team.placeholder.slice(-2)) === 'number' && team.value === ''){
                scoreForTeam = Number(team.placeholder.slice(-2));
            } else {
                scoreForTeam = score;
            }
            // each team gets the score added to the input box for the week in question added to an object for the week's scores
            const teamToScore = team.id.slice(0, -1);
            weekInQuestion = team.id.slice(-2);
            if (weekInQuestion[0] === "s") {
                weekInQuestion = weekInQuestion[1];
            }
            weeklyScores[weekInQuestion][teamToScore] = scoreForTeam;

        });

        const scores = [];
        // runs through scores of each week
        for (let i = 1; i < weeklySchedule.length; i++) {
            // find each score for each team in the week
            for (let item in weeklyScores[i]) {
                if (typeof weeklyScores[i][item] === `number`) {
                    // scores added to array; first and second array values will be compared to find winner
                    scores.push(weeklyScores[i][item]);
                    if (scores.length === 2) {
                        findWinner(scores, i)
                    }
                }
            }
        }
        // post standings inside div
        const standings = document.querySelector(`.standings`);



        // this is repeated so try to make it more modular
        for (let team in totalStandings.wins) {
            const teamInfo = {};
            teamInfo.team = team;
            teamInfo.winsRuns = `${totalStandings.wins[team]}0${totalStandings.runs[team]}`;
            teamInfo.winsRuns = ~~teamInfo.winsRuns;
            teamAndWinsRuns.push(teamInfo)
        }

        const compare = ( a, b ) => b - a
        
        teamAndWinsRuns.sort( compare );
        for (let i = 16; i < 19; i++) {
            if (i == 17) {
                weeklyScores[i][teamAndWinsRuns[1].team] = '';
                weeklyScores[i][teamAndWinsRuns[2].team] = '';
                weeklyScores[i][teamAndWinsRuns[0].team] = '';
                weeklyScores[i][teamAndWinsRuns[3].team] = '';
            } else {
                weeklyScores[i][teamAndWinsRuns[3].team] = '';
                weeklyScores[i][teamAndWinsRuns[0].team] = '';
                weeklyScores[i][teamAndWinsRuns[2].team] = '';
                weeklyScores[i][teamAndWinsRuns[1].team] = '';
            }
        }


        // update DB with new scores from that week and disable submit button
        // submitButton.disabled = true;
        // scoreKeeper.textContent = `Scores submitted for week ${weekInQuestion}`;
        // const childRef = ref(database, '-NKd-kS06Y9qY5yLoiKZ');
        // return set(childRef, weeklyScores);
    })

</script>
</html>